{
  "hash": "931437b613fadf48fe75a455556f0b9f",
  "result": {
    "markdown": "---\ntitle: geom_sf_text() and geom_sf_label() Are Coming!\nauthor: Hiroaki Yutani\ndate: '2018-10-10'\ncategories:\n  - tidyverse\n  - ggplot2\nformat:\n  html:\n    toc: true\n    toc-title: \"Contents\"\n    toc-location: left\n---\n\n\nggplot2 v3.1.0 will be released soon (hopefully), so let me do a spoiler about a small feature I implemented, `geom_sf_label()` and `geom_sf_text()`.\n\n## How can we add label/text with `geom_sf()`?\n\n[`geom_sf()`](https://ggplot2.tidyverse.org/reference/ggsf.html) is one of the most exciting features introduced in ggplot2 v3.0.0. It magically allows us to plot sf objects according to their geometries' shapes (polygons, lines and points).\n\nBut, for plotting them as some other shapes than the original ones, we cannot rely on `geom_sf()` so it needs a bit of data transformation beforehand. Suppose we want to add text on each geometry, we need to\n\n1.  calculate the proper point to add text/labels per geometry by some function like `sf::st_centroid()` and `sf::st_point_on_surface()`,\n2.  retrieve the coordinates from the calculated points by `sf::st_coordinates()`, and\n3.  use `geom_text()` or `geom_label()` with the coordinates\n\nThe code for this would be like below:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\n\nnc <- sf::st_read(system.file(\"shape/nc.shp\", package = \"sf\"), quiet = TRUE)\n\n# use only first three elements\nnc3 <- nc[1:3, ]\n\n# choose a point on the surface of each geometry\nnc3_points <- sf::st_point_on_surface(nc3)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in st_point_on_surface.sf(nc3): st_point_on_surface assumes attributes\nare constant over geometries of x\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in st_point_on_surface.sfc(st_geometry(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\n```\n:::\n\n```{.r .cell-code}\n# retrieve the coordinates\nnc3_coords <- as.data.frame(sf::st_coordinates(nc3_points))\nnc3_coords$NAME <- nc3$NAME\n\nnc3_coords\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n          X        Y      NAME\n1 -81.49496 36.42112      Ashe\n2 -81.13241 36.47396 Alleghany\n3 -80.69280 36.38828     Surry\n```\n:::\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = nc3, aes(fill = AREA)) +\n  geom_text(data = nc3_coords, aes(X, Y, label = NAME), colour = \"white\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/manual-1.png){width=672}\n:::\n:::\n\n\nPhew, this seems not so difficult, but I feel the code is a bit too long...\n\n## `geom_sf_label()` and `geom_sf_text()`\n\nFor this purpose, upcoming ggplot2 v3.1.0 provides two new geoms, `geom_sf_text()` and `geom_sf_label()`. The code equivalent to above can be written as:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# texts and labels\np <- ggplot(nc3) +\n  geom_sf(aes(fill = AREA))\n\np + geom_sf_text(aes(label = NAME), colour = \"white\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/geom_sf_text-1.png){width=672}\n:::\n:::\n\n\nFor labels, use `geom_sf_label()`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np + geom_sf_label(aes(label = NAME))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/geom_sf_label-1.png){width=672}\n:::\n:::\n\n\n## Protip: `stat_sf_coordinates()`\n\nUnder the hood, a `Stat` called `stat_sf_coordinates()` does the necessary calculations. If you are an expert of ggplot2, please play with this by combining with other `Geom`s. As an example, here's a preliminary version of `geom_sf_label_repel()` (which I want to implement next...):\n\n\n::: {.cell preview='true'}\n\n```{.r .cell-code}\nggplot(nc) +\n  geom_sf() +\n  ggrepel::geom_label_repel(\n    data = nc[c(1:3, 10:14), ],\n    aes(label = NAME, geometry = geometry),\n    stat = \"sf_coordinates\",\n    min.segment.length = 0,\n    colour = \"magenta\",\n    segment.colour = \"magenta\"\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not\ngive correct results for longitude/latitude data\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/geom_sf_label_repel-1.png){width=672}\n:::\n:::\n\n\nFor other cool NEWS of ggplot2 v3.1.0, please read the [`NEWS.md`](https://github.com/tidyverse/ggplot2/blob/3e1e6e43af82faf59e37df0724b65c8d829c7b07/NEWS.md#ggplot2-310) :)\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}